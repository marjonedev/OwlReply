<% if current_user %>
  <% content_for :javascript_includes do %>
    <script type="text/javascript" src="https://js.stripe.com/v2/"></script>
  <% end %>
<% end %>

<!-- Page Title
============================================= -->
<section id="page-title">

  <div class="container clearfix">
    <h1>Pricing</h1>
    <span>Choose your plan and get started on providing amazing customer service.</span>
  </div>

</section><!-- #page-title end -->

<section id="content">

  <div class="content-wrap">

    <div class="container clearfix">

      <div class="heading-block center">
        <span style="font-size: 22px">We support everyone from small-businesses to Enterprise.</span>
      </div>

      <div class="row pricing bottommargin clearfix">
        <%#= @plans %>
        <% @plans.each do |plan| %>
          <div class="col-lg">

            <div class="pricing-box <%= plan.recommended ? 'best-price' : '' %>">
              <div class="pricing-title">
                <h3><%= plan.name %></h3>
                <% if plan.recommended %>
                  <span>Most Popular</span>
                <% end %>
              </div>
              <div class="pricing-price">
                <% if plan.price.to_i > 0 %>
                  <span class="price-unit">USD</span>
                <% end %>
                <%= plan_amount(plan.price) %>
                <% if plan.price.to_i > 0 %>
                  <span class="price-tenure">/<%= plan_frequency(plan.frequency) %></span>
                <% end %>
             </div>
              <div class="pricing-features">
                <%= raw(plan.feature) %>
              </div>
              <div class="pricing-action"><% s1 = Subscription.find_by(name: plan.name).id %>
                <% if current_user %>
                  <% if current_user.subscription_id == s1 || current_user.subscription_id.nil? #current_user.subscription_id != (s=Subscription.find_by(name: "Entrepreneur").id) %>
                    <a href="#" class="btn btn-block btn-lg ls3" onclick="return false;">Current Plan</a>
                  <% else %>
                    <% if current_user.no_paymentmethods? %>
                      <% button_class = plan.recommended ? 'btn btn-danger btn-block btn-lg bgcolor border-color' : 'btn btn-danger btn-block btn-lg' %>
                      <%= link_to 'Choose Plan', "/paymentmethods/new?upgrade=#{s1}", class: button_class, remote: true %>
                    <% else %>
                      <% button_class = plan.recommended ? 'btn btn-danger btn-block btn-lg bgcolor border-color confirm-plan' : 'btn btn-danger btn-block btn-lg confirm-plan' %>
                      <%= link_to 'Choose Plan', plan_path(s1), class: button_class, data:{toggle: 'modal', plan: plan.name} %>
                    <% end %>
                  <% end %>
                <% else %>
                  <% button_class = plan.recommended ? 'btn btn-danger btn-block btn-lg bgcolor border-color' : 'btn btn-danger btn-block btn-lg' %>
                  <a href="/signup" class="<%= button_class %>">Sign Up</a>
                <% end %>
              </div>
            </div>

          </div>
        <% end %>

      </div>

    </div>

  </div>

</section><!-- #content end -->
<% if current_user %>
  <% content_for :modals_includes do %>
    <div class="modal fade" id="ConfirmPlanModal" tabindex="-1" role="dialog" aria-labelledby="ConfirmPlanModal" aria-hidden="true">
      <div class="modal-dialog modal-sm">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title text-center" style="width: 100%">Confirm Plan Change</h4>
          </div>
          <div class="modal-body">
            <h5 class="text-center">You are selecting <span class="plan-name"></span> plan.</h5>
            <% if !current_user.next_subscription_charge_on.nil? %>
              <p class="text-center">Plan will change on <%= current_user.next_subscription_charge_on.strftime("%D") %>.</p>
            <% end %>
            <div>
              <%= link_to 'Confirm', '#', method: :put, class: 'button button-large tright', id: 'confirm_plan', remote: true %>
              <button type="button" class="button button-large button-white button-light" data-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <% content_for :javascript_footer_includes do %>
    <script type="text/javascript">
        $(function () {
            $('.confirm-plan').on('click', function (e) {
                e.preventDefault();
                var $name = $(this).attr('data-plan');
                var $target = $(this).attr('href');
                $('#ConfirmPlanModal').find('span.plan-name').text($name);
                $('#ConfirmPlanModal').find('#confirm_plan').attr('href', $target);
                $('#ConfirmPlanModal').modal('show');

                return false;
            });

            $('#confirm_plan').on('click', function () {
                $('#ConfirmPlanModal').modal('hide');

                return true;
            });

            $('#ConfirmPlanModal').on('hidden.bs.modal', function () {
                $(this).find('span.plan-name').text('');
                $(this).find('#confirm_plan').attr('href', '#');
            });
        });
    </script>
  <% end %>
<% end %>