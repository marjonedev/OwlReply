<div class="card">
  <div class="card-body">
    <% if emailaccount.errors.any? %>
      <div class="style-msg2 errormsg">
        <div class="msgtitle">Oops! There's an error upon submitting.</div>
        <div class="sb-msg">
          <ul>
            <% for message in emailaccount.errors.full_messages %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      </div>
    <% end %>

    <%= form_with model: (emailaccount || emailaccount = Emailaccount.new), html:{class: 'nobottommargin'} do |f| %>
      <div class="form-group">
        <label>Email Address</label>
        <% if is_main_account(emailaccount) %>
          <%= f.text_field :address, class: 'form-control readonly', readonly: 'readonly' %>
        <% else %>
          <%= f.text_field :address, class: 'form-control required', required: 'required' %>
        <% end %>
      </div>
      <% if emailaccount.authenticated %>
        <div class="style-msg" style="background-color: #EEE;">
          <div class="sb-msg">
            <%= link_to 'Revoke Access', revoke_account_access_emailaccount_path(emailaccount), onclick: "return confirm('Are you sure to revoke access?')", class: "button button-3d button-mini button-rounded button-leaf" %>
            Your account has been authenticated.
            <%= link_to 'Reauthorize', connect_emailaccount_path(emailaccount), class: "", remote: true %>
          </div>
        </div>
       <% else %>
        <div class="style-msg style-msg-light" style="background-color: #333;">
          <div class="sb-msg">
            <%= link_to 'Connect', '#', class: "btn-connect button button-3d button-mini button-rounded button-white button-light", remote: true %> Your account needs to be authenticated. Please connect your IMAP account.
          </div>
        </div>
       <% end %>

      <!--<div class="form-group">
        <label>Password</label>
        <%#= f.password_field :password, class: 'form-control', required: 'required' %>
      </div>
      <div class="form-group">
        <label>Encrypted Password</label>
        <%#= f.text_field :encrypted_password, class: 'form-control' %>
      </div>
      <div class="form-group">
        <label>Encryption Key</label>
        <%#= f.text_field :encryption_key, class: 'form-control' %>
      </div>-->
      <div class="form-group" id="template">
        <label>Email Template</label>
        <%= f.text_area :template, class: 'form-control' %>
        <small class="form-text text-muted">
          use  <strong>%%reply%%</strong>  short tag to insert the content of the reply
        </small>
        <% if @emailaccount&.template.blank? %><%# this is the same as if @emailaccount && @emailaccount.template.blank? %>
          <div class="style-msg suggested-template-button" style="margin: 5px 0;">
            <div class="sb-msg">
              <%= link_to 'Use our suggested reply', '#', class: 'btn-suggest button button-3d button-mini button-rounded button-white button-light' %>
              You don't have a default email reply yet. Click this for an example.
            </div>
          </div>
        <% end %>
      </div>

      <div class="card-footer noleftpadding norightpadding nobottompadding bg-white">
        <%= f.submit 'Save', :class => 'button nomargin' %>
        <%= link_to 'Cancel', emailaccount_url(emailaccount), class: 'button-cancel button button-white button-light' %>
        <% unless is_main_account(emailaccount) %>
          <%= link_to 'Remove', remove_emailaccount_path(emailaccount), class: 'button-remove button button-red float-right', method: :delete, remote: true %>
        <% end %>
      </div>


    <% end %>
  </div>
</div>

<% unless @emailaccount.authenticated %>
  <% content_for :modals_includes do %>
    <div class="modal fade" id="ConnectEmailAccount" tabindex="-1" role="dialog" aria-labelledby="ConnectEmailAccount" aria-hidden="true">
      <div class="modal-dialog modal-md">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title text-center" style="width: 100%">Connect Your Email Account</h4>
          </div>
          <div class="modal-body">
            <%= form_for @emailaccount, url: connect_emailaccount_path, remote:true, html:{class: 'nobottommargin'}, local: false do |f| %>
              <div class="form-group">
                <label for="emailProvider">Email Provider</label>
                <select class="form-control" id="emailProvider" name="emailaccount[email_provider]">
                  <option value="google" <%= html_attr_selected @emailaccount.email_provider, 'google' %>>Google</option>
                  <option value="other" <%= html_attr_selected @emailaccount.email_provider, 'other' %>>Others</option>
                </select>
              </div>
              <% display_smtp = html_attr_selected(@emailaccount.email_provider, 'other') === "selected=selected" ? '' : 'style=display:none' %>
              <div id="smtpSettings" <%= display_smtp %>>
                <div class="form-group">
                  <label>Email</label>
                  <%= f.text_field :address, class: 'form-control', readonly: 'readonly' %>
                </div>
                <div class="form-group">
                  <label>Server</label>
                  <%= f.text_field :imap_host, class: 'form-control' %>
                </div>
                <div class="form-group">
                  <label>Password</label>
                  <%= f.text_field :password, class: 'form-control' %>
                </div>
                <div class="form-group">
                  <label>Port</label>
                  <% port = @emailaccount.imap_port ?  @emailaccount.imap_port : 993 %>
                  <%= f.text_field :imap_port, class: 'form-control', value: port %>`
                </div>
                <div class="form-group">
                  <div class="form-group form-check">
                    <% sslcheck = @emailaccount.imap_ssl ? @emailaccount.imap_ssl : false %>
                    <%= f.check_box :imap_ssl, class: 'form-check-input', id: 'ssl_required', checked: sslcheck %>
                    <label for="ssl_required">Use SSL</label>
                  </div>
                </div>
              </div>
              <div class="form-group">
                <%
                  google_class = html_attr_selected(@emailaccount.email_provider, 'google') === "selected=selected" ? 'googled' : ''
                  if @emailaccount.email_provider.nil?
                    google_class = 'googled'
                  end
                %>
                <button type="submit" class="button button-large button-rounded button-connect float-left <%= google_class %>">Connect</button>
                <button type="button" data-dismiss="modal" class="button button-white button-light button-large button-rounded float-right">Cancel</button>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <% content_for :javascript_footer_includes do %>
    <script type="text/javascript">

        $(function () {
            $('.btn-connect').on('click', function (e) {
                e.preventDefault();
                $('#ConnectEmailAccount').modal('show');
                return false;
            });

            $('#emailProvider').on('change', function () {
                var value = $(this).val();
                if (value == 'other'){
                    $('#smtpSettings').show();
                    $('button.button-connect').removeClass('googled');
                }else{
                    $('#smtpSettings').hide();
                    $('button.button-connect').addClass('googled');
                }
            });

            $('#ConnectEmailAccount').on('hidden.bs.modal', function () {});

            $('#ConnectEmailAccount').find('button[type=submit]').on('click', function(e){
                e.preventDefault();
                var $this = this;
                var form = $($this).closest('form');

                var send = function(form){
                    var elem = $(form)[0];
                    Rails.fire(elem, 'submit');
                };

                if(form.find('#emailProvider').val() == "google"){
                    send(form);
                }else{
                    var authenticating = function(elem){
                        $(elem).html('<i class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></i> Authenticating...')
                            .addClass('disabled')
                            .attr({'disabled': 'disabled', 'value': 'Authenticating...'});
                    };

                    var doneErrorAuth = function(elem){
                        $('#smtpSettings').find('.errorMsg').remove();
                        $('#smtpSettings').append('<div class="errorMsg">' +
                            '<div class="alert alert-danger" role="alert">Opps. Authentication Error. Please try again.</div>' +
                            '</div>');
                        $(elem).text('Connect')
                            .removeClass('disabled')
                            .removeAttr('disabled');
                    };

                    authenticating($this);

                    $.ajax({
                        url: "<%= authenticate_imap_emailaccount_path(@emailaccount, :format => :json) %>",
                        type: "GET",
                        data: $(form).serialize(),
                        contentType: "application/json",
                        success: function(data){
                            if(data){
                                if(data.success){
                                    $($this).text('Authenticated');
                                    send(form);
                                }else{
                                    doneErrorAuth($this);
                                }
                            }
                        }
                    });
                }




            });
        });
    </script>
  <% end %>
<% end %>
<script>
  $(function () {
    $('.btn-suggest').on('click', function (e) {
      e.preventDefault();
      $('.btn-suggest').text('Make it even better');
      $("#emailaccount_template").val("Hello there!\n\nThank you so much for emailing our company.\n\n%%reply%%\n\nWe hope to work with you more soon.\n\nSincerely,\n\nJohn\nCustomer Service Agent");
      $('.btn-suggest').off('click').on('click', function (e) {
        e.preventDefault();
        $('.suggested-template-button').remove();
        $("#emailaccount_template").val("Hello there!\n\nWe are absolutely thrilled to hear from you. Thanks a lot for emailing.\n\n%%reply%%\n\nIf that doesn't solve your problem, email me back and I will look further into it for you! We're really glad to have you on board with the best company in the world.\n\nSincerely,\n\nJohn\nCustomer Enthusiast");
        return false;
      });
      return false;
    });
  });
</script>